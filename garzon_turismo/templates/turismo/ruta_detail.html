{% extends 'base.html' %}
{% load static %}

{% block title %}{{ ruta.nombre }} - Rutas Turísticas - {{ block.super }}{% endblock %}

{% block meta_description %}{{ ruta.descripcion|truncatewords:30|striptags }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/route_maps.css' %}">
{% endblock %}

{% block breadcrumb %}
<section class="breadcrumb-section">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Inicio</a></li>
                <li class="breadcrumb-item"><a href="{% url 'turismo:ruta_list' %}">Rutas Turísticas</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ ruta.nombre }}</li>
            </ol>
        </nav>
    </div>
</section>
{% endblock %}

{% block content %}
<!-- Hero de la Ruta -->
<section class="section route-hero">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                {% if ruta.imagen_principal %}
                <div class="route-hero-img mb-4" data-aos="fade-up">
                    <img src="{{ ruta.imagen_principal.url }}" alt="{{ ruta.nombre }}" class="img-fluid rounded shadow-lg">
                </div>
                {% endif %}
                
                <div class="route-hero-content" data-aos="fade-up" data-aos-delay="100">
                    <div class="route-badges mb-3">
                        <span class="badge bg-{{ ruta.get_color_dificultad }} me-2 px-3 py-2">
                            <i class="ph-flag"></i> {{ ruta.get_dificultad_display }}
                        </span>
                        <span class="badge bg-info me-2 px-3 py-2">
                            <i class="ph-clock"></i> {{ ruta.duracion_estimada }}
                        </span>
                        <span class="badge bg-secondary px-3 py-2">
                            <i class="ph-path"></i> {{ ruta.distancia }} km
                        </span>
                    </div>
                    
                    <h1 class="route-title mb-4 display-4 fw-bold" style="color: #2c3e50;">{{ ruta.nombre }}</h1>
                    
                    <div class="route-stats-grid">
                        <div class="row g-4">
                            <div class="col-md-3">
                                <div class="stat-item bg-white p-3 rounded shadow-sm">
                                    <div class="stat-icon mb-2" style="color: #5DAD47;">
                                        <i class="ph-timer display-6"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h6 class="text-muted mb-1">Duración</h6>
                                        <p class="fw-bold mb-0">{{ ruta.duracion_estimada }}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="stat-item bg-white p-3 rounded shadow-sm">
                                    <div class="stat-icon mb-2" style="color: #5DAD47;">
                                        <i class="ph-path display-6"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h6 class="text-muted mb-1">Distancia</h6>
                                        <p class="fw-bold mb-0">{{ ruta.distancia }} km</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="stat-item bg-white p-3 rounded shadow-sm">
                                    <div class="stat-icon mb-2" style="color: #5DAD47;">
                                        <i class="ph-flag display-6"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h6 class="text-muted mb-1">Dificultad</h6>
                                        <p class="fw-bold mb-0">{{ ruta.get_dificultad_display }}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="stat-item bg-white p-3 rounded shadow-sm">
                                    <div class="stat-icon mb-2" style="color: #5DAD47;">
                                        <i class="ph-map-trifold display-6"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h6 class="text-muted mb-1">Puntos</h6>
                                        <p class="fw-bold mb-0">{{ puntos.count }} paradas</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="route-sidebar">
                    <!-- Información Rápida -->
                    <div class="sidebar-widget route-quick-info bg-white rounded shadow-sm p-4 mb-4" data-aos="fade-left">
                        <h5 class="widget-title mb-3 fw-bold" style="color: #2c3e50;">
                            <i class="ph-info me-2" style="color: #5DAD47;"></i>
                            Información de la Ruta
                        </h5>
                        <div class="quick-info-content">
                            <div class="info-row d-flex justify-content-between py-2 border-bottom">
                                <span class="info-label d-flex align-items-center text-muted">
                                    <i class="ph-play me-2" style="color: #22C55E;"></i> Punto de Inicio
                                </span>
                                <span class="info-value fw-semibold">
                                    {% if ruta.get_primer_punto %}
                                        {{ ruta.get_primer_punto.get_nombre_display|truncatechars:20 }}
                                    {% else %}
                                        No definido
                                    {% endif %}
                                </span>
                            </div>
                            <div class="info-row d-flex justify-content-between py-2 border-bottom">
                                <span class="info-label d-flex align-items-center text-muted">
                                    <i class="ph-stop me-2" style="color: #EF4444;"></i> Punto Final
                                </span>
                                <span class="info-value fw-semibold">
                                    {% if ruta.get_ultimo_punto %}
                                        {{ ruta.get_ultimo_punto.get_nombre_display|truncatechars:20 }}
                                    {% else %}
                                        No definido
                                    {% endif %}
                                </span>
                            </div>
                            <div class="info-row d-flex justify-content-between py-2 border-bottom">
                                <span class="info-label d-flex align-items-center text-muted">
                                    <i class="ph-calendar me-2" style="color: #5DAD47;"></i> Mejor Época
                                </span>
                                <span class="info-value fw-semibold">Todo el año</span>
                            </div>
                            <div class="info-row d-flex justify-content-between py-2">
                                <span class="info-label d-flex align-items-center text-muted">
                                    <i class="ph-users me-2" style="color: #5DAD47;"></i> Recomendado para
                                </span>
                                <span class="info-value fw-semibold">
                                    {% if ruta.dificultad == 'facil' %}
                                        Familias
                                    {% elif ruta.dificultad == 'media' %}
                                        Aventureros
                                    {% else %}
                                        Expertos
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compartir -->
                    <div class="sidebar-widget share-widget bg-white rounded shadow-sm p-4 mb-4" data-aos="fade-left" data-aos-delay="100">
                        <h5 class="widget-title mb-3 fw-bold" style="color: #2c3e50;">
                            <i class="ph-share-network me-2" style="color: #5DAD47;"></i>
                            Compartir Ruta
                        </h5>
                        <div class="share-buttons d-grid gap-2">
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="share-btn facebook btn btn-primary d-flex align-items-center justify-content-center">
                                <i class="ph-facebook-logo me-2"></i>
                                Facebook
                            </a>
                            <a href="https://twitter.com/intent/tweet?text={{ ruta.nombre }}&url={{ request.build_absolute_uri }}" target="_blank" class="share-btn twitter btn btn-info d-flex align-items-center justify-content-center">
                                <i class="ph-twitter-logo me-2"></i>
                                Twitter
                            </a>
                            <a href="https://wa.me/?text={{ ruta.nombre }} {{ request.build_absolute_uri }}" target="_blank" class="share-btn whatsapp btn btn-success d-flex align-items-center justify-content-center">
                                <i class="ph-whatsapp-logo me-2"></i>
                                WhatsApp
                            </a>
                        </div>
                    </div>
                    
                    <!-- Herramientas -->
                    <div class="sidebar-widget download-widget bg-white rounded shadow-sm p-4" data-aos="fade-left" data-aos-delay="200">
                        <h5 class="widget-title mb-3 fw-bold" style="color: #2c3e50;">
                            <i class="ph-toolbox me-2" style="color: #5DAD47;"></i>
                            Herramientas
                        </h5>
                        <div class="widget-content">
                            <p class="mb-3 text-muted">Descarga la ruta en formato GPX para usar en tu dispositivo GPS.</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" id="downloadGPX">
                                    <i class="ph-download me-2"></i> Descargar GPX
                                </button>
                                <button class="btn btn-outline-secondary" onclick="window.print()">
                                    <i class="ph-printer me-2"></i> Imprimir Ruta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Descripción de la Ruta -->
<section class="section route-description bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="content-section bg-white rounded shadow-sm p-4 mb-4" data-aos="fade-up">
                    <h3 class="mb-3 fw-bold" style="color: #2c3e50;">
                        <i class="ph-article me-2" style="color: #5DAD47;"></i>
                        Acerca de esta Ruta
                    </h3>
                    <div class="route-description-text">
                        {{ ruta.descripcion|linebreaks }}
                    </div>
                </div>
                
                {% if ruta.recomendaciones %}
                <div class="content-section bg-white rounded shadow-sm p-4" data-aos="fade-up" data-aos-delay="100">
                    <h3 class="mb-3 fw-bold" style="color: #2c3e50;">
                        <i class="ph-lightbulb me-2" style="color: #5DAD47;"></i>
                        Recomendaciones
                    </h3>
                    <div class="recommendations-content">
                        {{ ruta.recomendaciones|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Mapa Interactivo de la Ruta -->
<section class="section py-5">
    <div class="container">
        <div class="section-header text-center mb-5" data-aos="fade-up">
            <h2 class="section-title display-5 fw-bold mb-3" style="color: #2c3e50;">
                <i class="ph-map-trifold me-3" style="color: #5DAD47;"></i>
                Mapa Interactivo
            </h2>
            <p class="section-text lead text-muted mx-auto" style="max-width: 600px;">
                Explora la ruta completa con nuestro mapa interactivo. Haz clic en los marcadores para obtener información detallada de cada punto.
            </p>
        </div>
        
        <div class="route-map-container route-{{ ruta.slug }}" data-aos="fade-up" data-aos-delay="200">
            <div id="route-map" class="route-map" style="height: 500px; width: 100%; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"></div>
        </div>
    </div>
</section>

<!-- Puntos de la Ruta -->
<section class="section section-light py-5">
    <div class="container">
        <div class="section-header text-center mb-5" data-aos="fade-up">
            <h2 class="section-title display-5 fw-bold mb-3" style="color: #2c3e50;">
                <i class="ph-map-pin me-3" style="color: #5DAD47;"></i>
                Puntos de la Ruta
            </h2>
            <p class="section-text lead text-muted mx-auto" style="max-width: 600px;">
                Descubre cada parada de esta increíble ruta turística y planifica tu aventura
            </p>
        </div>
        
        <div class="route-timeline">
            {% for punto in puntos %}
            <div class="timeline-item" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1|stringformat:'d' }}00">
                <div class="timeline-marker">
                    <div class="timeline-number">{{ punto.orden }}</div>
                </div>
                
                <div class="timeline-content">
                    <div class="row align-items-center">
                        <div class="col-lg-4">
                            {% if punto.get_imagen %}
                                <div class="timeline-img">
                                    <img src="{{ punto.get_imagen.url }}" alt="{{ punto.get_nombre_display }}" class="img-fluid rounded">
                                </div>
                            {% else %}
                                <div class="timeline-placeholder">
                                    <i class="ph-map-pin"></i>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-lg-8">
                            <div class="timeline-info">
                                <h4 class="timeline-title">{{ punto.get_nombre_display }}</h4>
                                
                                <div class="timeline-meta">
                                    {% if punto.tiempo_estancia %}
                                    <span class="meta-item">
                                        <i class="ph-clock"></i> {{ punto.tiempo_estancia }}
                                    </span>
                                    {% endif %}
                                    <span class="meta-item">
                                        <i class="ph-map-pin"></i> Punto {{ punto.orden }} de {{ puntos.count }}
                                    </span>
                                    <span class="meta-item">
                                        <i class="ph-navigation-arrow"></i> {{ punto.latitud|floatformat:4 }}, {{ punto.longitud|floatformat:4 }}
                                    </span>
                                </div>
                                
                                {% if punto.get_descripcion_display %}
                                <p class="timeline-description">{{ punto.get_descripcion_display|truncatewords:30 }}</p>
                                {% endif %}
                                
                                <div class="timeline-actions">
                                    {% if punto.lugar_turistico %}
                                    <a href="{{ punto.lugar_turistico.get_absolute_url }}" class="btn btn-primary btn-sm">
                                        <i class="ph-arrow-right"></i> Ver Lugar
                                    </a>
                                    {% endif %}
                                    <button class="btn btn-outline-primary btn-sm" onclick="showPointOnMap({{ punto.latitud }}, {{ punto.longitud }}, '{{ punto.get_nombre_display }}')">
                                        <i class="ph-map-pin"></i> Ver en Mapa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Rutas Similares -->
{% if rutas_similares %}
<section class="section py-5">
    <div class="container">
        <div class="section-header text-center mb-5" data-aos="fade-up">
            <h2 class="section-title display-5 fw-bold mb-3" style="color: #2c3e50;">
                <i class="ph-path me-3" style="color: #5DAD47;"></i>
                Rutas Similares
            </h2>
            <p class="section-text lead text-muted mx-auto" style="max-width: 600px;">
                Otras rutas que podrían interesarte para completar tu experiencia en Garzón
            </p>
        </div>
        
        <div class="row g-4">
            {% for ruta_sim in rutas_similares %}
            <div class="col-lg-4 col-md-6 mb-4" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1|stringformat:'d' }}00">
                <div class="card route-card h-100 shadow-sm border-0">
                    <div class="route-img position-relative" style="height: 200px; overflow: hidden;">
                        {% if ruta_sim.imagen_principal %}
                            <img src="{{ ruta_sim.imagen_principal.url }}" alt="{{ ruta_sim.nombre }}" class="card-img-top h-100 w-100" style="object-fit: cover;">
                        {% else %}
                            <img src="{% static 'img/placeholder.jpg' %}" alt="{{ ruta_sim.nombre }}" class="card-img-top h-100 w-100" style="object-fit: cover;">
                        {% endif %}
                        
                        <div class="position-absolute top-0 start-0 m-3">
                            <span class="badge bg-{{ ruta_sim.get_color_dificultad }} px-3 py-2 rounded-pill">
                                {{ ruta_sim.get_dificultad_display }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title fw-bold mb-3">
                            <a href="{{ ruta_sim.get_absolute_url }}" class="text-decoration-none text-dark">{{ ruta_sim.nombre }}</a>
                        </h5>
                        
                        <div class="route-meta mb-3">
                            <div class="row g-2 small text-muted">
                                <div class="col-6">
                                    <i class="ph-timer me-1" style="color: #5DAD47;"></i>
                                    <strong>{{ ruta_sim.duracion_estimada }}</strong>
                                </div>
                                <div class="col-6">
                                    <i class="ph-path me-1" style="color: #5DAD47;"></i>
                                    <strong>{{ ruta_sim.distancia }} km</strong>
                                </div>
                            </div>
                        </div>
                        
                        <p class="card-text text-muted flex-grow-1">{{ ruta_sim.descripcion|truncatewords:15 }}</p>
                        
                        <a href="{{ ruta_sim.get_absolute_url }}" class="btn mt-auto" style="background-color: #5DAD47; color: white; border-color: #5DAD47;">
                            <i class="ph-arrow-right me-1"></i> Explorar Ruta
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Llamada a la Acción -->
<section class="section text-white py-5" style="background: linear-gradient(135deg, #5DAD47 0%, #4a9639 100%);">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <div class="cta-content" data-aos="fade-up">
                    <h3 class="display-5 fw-bold mb-3">¿Listo para vivir esta experiencia?</h3>
                    <p class="lead mb-4 text-white">Contacta con nuestros guías locales para obtener información personalizada y hacer de tu visita una experiencia inolvidable.</p>
                    <div class="d-flex flex-wrap justify-content-center gap-3">
                        <a href="{% url 'contacto:contacto' %}" class="btn btn-light btn-lg px-4 py-3">
                            <i class="ph-chat-circle me-2"></i> Contactar Guía
                        </a>
                        <a href="{% url 'turismo:lugar_list' %}" class="btn btn-outline-light btn-lg px-4 py-3">
                            <i class="ph-compass me-2"></i> Ver Más Destinos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Script para pasar datos a JavaScript -->
<script>
    // Datos de la ruta para el mapa
    const routeDetailData = {
        ruta: {
            id: {{ ruta.id }},
            nombre: "{{ ruta.nombre|escapejs }}",
            slug: "{{ ruta.slug }}",
            descripcion: "{{ ruta.descripcion|escapejs }}",
            distancia: {{ ruta.distancia }},
            duracion_estimada: "{{ ruta.duracion_estimada|escapejs }}",
            dificultad: "{{ ruta.dificultad }}"
        },
        puntos: [
            {% for punto in puntos %}
            {
                id: {{ punto.id }},
                orden: {{ punto.orden }},
                nombre: "{{ punto.get_nombre_display|escapejs }}",
                descripcion: "{{ punto.get_descripcion_display|escapejs }}",
                latitud: {{ punto.latitud }},
                longitud: {{ punto.longitud }},
                tiempo_estancia: "{{ punto.tiempo_estancia|default:''|escapejs }}",
                {% if punto.get_imagen %}
                imagen: "{{ punto.get_imagen.url }}"
                {% else %}
                imagen: null
                {% endif %}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    console.log('Datos de la ruta cargados:', routeDetailData);
</script>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let routeMap;
let markers = [];
let routePath;

// Función de callback para Google Maps
window.initGoogleMaps = function() {
    console.log('Google Maps API cargada, inicializando mapa de ruta...');
    
    // Verificar si tenemos datos
    if (!routeDetailData || !routeDetailData.puntos || routeDetailData.puntos.length === 0) {
        console.error('No hay datos de puntos disponibles');
        showMapError('No hay puntos de ruta disponibles');
        return;
    }
    
    try {
        initRouteMap();
    } catch (error) {
        console.error('Error inicializando el mapa:', error);
        showMapError('Error al cargar el mapa: ' + error.message);
    }
};

// Función para inicializar el mapa de la ruta
function initRouteMap() {
    const mapContainer = document.getElementById('route-map');
    
    if (!mapContainer) {
        console.error('Contenedor del mapa no encontrado');
        return;
    }
    
    // Calcular el centro y bounds del mapa
    const bounds = new google.maps.LatLngBounds();
    const puntos = routeDetailData.puntos;
    
    // Centro por defecto en Garzón si no hay puntos
    let center = { lat: 2.1975, lng: -75.6514 };
    
    if (puntos.length > 0) {
        // Usar el primer punto como centro inicial
        center = { lat: puntos[0].latitud, lng: puntos[0].longitud };
        
        // Extender bounds con todos los puntos
        puntos.forEach(punto => {
            bounds.extend(new google.maps.LatLng(punto.latitud, punto.longitud));
        });
    }
    
    // Crear el mapa
    routeMap = new google.maps.Map(mapContainer, {
        zoom: 13,
        center: center,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        styles: [
            {
                featureType: 'poi',
                elementType: 'labels',
                stylers: [{ visibility: 'on' }]
            },
            {
                featureType: 'transit',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }]
            }
        ],
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
        zoomControl: true
    });
    
    console.log('Mapa base creado');
    
    // Agregar marcadores
    addRouteMarkers();
    
    // Dibujar la ruta si hay más de un punto
    if (puntos.length > 1) {
        drawRoutePath();
    }
    
    // Ajustar la vista al contenido
    if (puntos.length > 1) {
        routeMap.fitBounds(bounds);
        
        // Asegurar un zoom mínimo
        const listener = google.maps.event.addListener(routeMap, 'idle', function() {
            if (routeMap.getZoom() > 15) routeMap.setZoom(15);
            google.maps.event.removeListener(listener);
        });
    }
    
    console.log('Mapa de ruta inicializado correctamente con ' + puntos.length + ' puntos');
}

// Función para agregar marcadores
function addRouteMarkers() {
    const puntos = routeDetailData.puntos;
    
    puntos.forEach((punto, index) => {
        const position = { lat: punto.latitud, lng: punto.longitud };
        
        // Crear marcador personalizado
        const marker = new google.maps.Marker({
            position: position,
            map: routeMap,
            title: punto.nombre,
            label: {
                text: punto.orden.toString(),
                color: 'white',
                fontWeight: 'bold',
                fontSize: '14px'
            },
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: index === 0 ? '#22C55E' : (index === puntos.length - 1 ? '#EF4444' : '#5DAD47'),
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 2,
                scale: 12
            },
            animation: google.maps.Animation.DROP
        });
        
        // Crear ventana de información
        const infoWindow = new google.maps.InfoWindow({
            content: createInfoWindowContent(punto, index)
        });
        
        // Agregar evento click
        marker.addListener('click', function() {
            // Cerrar otras ventanas
            markers.forEach(m => {
                if (m.infoWindow) {
                    m.infoWindow.close();
                }
            });
            
            infoWindow.open(routeMap, marker);
        });
        
        // Guardar referencia
        markers.push({
            marker: marker,
            infoWindow: infoWindow,
            punto: punto
        });
    });
    
    console.log('Agregados ' + markers.length + ' marcadores al mapa');
}

// Función para crear contenido de la ventana de información
function createInfoWindowContent(punto, index) {
    const isFirst = index === 0;
    const isLast = index === routeDetailData.puntos.length - 1;
    
    let statusText = 'Punto intermedio';
    let statusColor = '#5DAD47';
    
    if (isFirst) {
        statusText = 'Punto de inicio';
        statusColor = '#22C55E';
    } else if (isLast) {
        statusText = 'Punto final';
        statusColor = '#EF4444';
    }
    
    return `
        <div style="max-width: 300px; padding: 10px;">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <div style="background: ${statusColor}; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 8px;">
                    ${punto.orden}
                </div>
                <div>
                    <h6 style="margin: 0; color: #2c3e50; font-weight: bold;">${punto.nombre}</h6>
                    <small style="color: ${statusColor}; font-weight: 500;">${statusText}</small>
                </div>
            </div>
            ${punto.descripcion ? `<p style="margin: 10px 0; color: #666; font-size: 14px; line-height: 1.4;">${punto.descripcion}</p>` : ''}
            ${punto.tiempo_estancia ? `
                <div style="margin: 8px 0; font-size: 13px; color: #888;">
                    <i class="ph-clock" style="margin-right: 4px;"></i>
                    Tiempo recomendado: ${punto.tiempo_estancia}
                </div>
            ` : ''}
            <div style="margin-top: 10px; font-size: 12px; color: #999;">
                Coordenadas: ${punto.latitud.toFixed(4)}, ${punto.longitud.toFixed(4)}
            </div>
        </div>
    `;
}

// Función para dibujar la ruta
function drawRoutePath() {
    const puntos = routeDetailData.puntos;
    
    if (puntos.length < 2) return;
    
    const path = puntos.map(punto => ({
        lat: punto.latitud,
        lng: punto.longitud
    }));
    
    routePath = new google.maps.Polyline({
        path: path,
        geodesic: true,
        strokeColor: '#5DAD47',
        strokeOpacity: 1.0,
        strokeWeight: 3,
        icons: [{
            icon: {
                path: google.maps.SymbolPath.FORWARD_OPEN_ARROW,
                strokeColor: '#5DAD47',
                strokeWeight: 2,
                scale: 3
            },
            offset: '100%',
            repeat: '100px'
        }]
    });
    
    routePath.setMap(routeMap);
    console.log('Ruta dibujada conectando ' + puntos.length + ' puntos');
}

// Función para mostrar un punto específico en el mapa
function showPointOnMap(lat, lng, nombre) {
    if (!routeMap) {
        console.warn('El mapa no está inicializado aún');
        return;
    }
    
    // Centrar el mapa en el punto
    const position = new google.maps.LatLng(lat, lng);
    routeMap.setCenter(position);
    routeMap.setZoom(16);
    
    // Encontrar y abrir la ventana de información correspondiente
    const markerData = markers.find(m => 
        m.punto.latitud === lat && m.punto.longitud === lng
    );
    
    if (markerData) {
        // Cerrar otras ventanas
        markers.forEach(m => {
            if (m.infoWindow) {
                m.infoWindow.close();
            }
        });
        
        // Abrir la ventana del punto seleccionado
        markerData.infoWindow.open(routeMap, markerData.marker);
        
        // Hacer bounce al marcador
        markerData.marker.setAnimation(google.maps.Animation.BOUNCE);
        setTimeout(() => {
            markerData.marker.setAnimation(null);
        }, 2000);
    }
    
    // Scroll suave al mapa
    document.getElementById('route-map').scrollIntoView({
        behavior: 'smooth',
        block: 'center'
    });
}

// Función para mostrar error en el mapa
function showMapError(message = 'No se pudieron cargar los datos de la ruta') {
    const mapContainer = document.getElementById('route-map');
    if (mapContainer) {
        const errorHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 500px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; color: #6c757d; text-align: center;">
                <div>
                    <div style="font-size: 4rem; margin-bottom: 20px;">🗺️</div>
                    <h4 style="margin-bottom: 10px;">Mapa no disponible</h4>
                    <p style="margin: 0;">${message}</p>
                </div>
            </div>
        `;
        mapContainer.innerHTML = errorHTML;
    }
}

// Manejo de errores de autenticación de Google Maps
window.gm_authFailure = function() {
    console.error('Error de autenticación de Google Maps API');
    showMapError('Error de autenticación. Verifica tu API key de Google Maps.');
};

// Función para descargar GPX (placeholder)
document.addEventListener('DOMContentLoaded', function() {
    const downloadBtn = document.getElementById('downloadGPX');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            alert('Función de descarga GPX próximamente disponible');
        });
    }
});
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVxz-5XL-Irl8AII_GwTo6nqe7eCDoyeo&libraries=geometry,places&callback=initGoogleMaps"></script>
{% endblock %}