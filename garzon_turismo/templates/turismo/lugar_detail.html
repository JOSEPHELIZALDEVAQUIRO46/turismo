{% extends 'base.html' %}
{% load static %}

{% block title %}{{ lugar.nombre }} - Lugares Turísticos - Alma del Huila{% endblock %}
{% block meta_description %}{{ lugar.descripcion|striptags|truncatewords:25 }}{% endblock %}

{% block body_class %}lugar-detail-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lg-zoom.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lg-thumbnail.min.css">
{% endblock %}

{% block breadcrumb %}
<section class="breadcrumb-section">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Inicio</a></li>
                <li class="breadcrumb-item"><a href="{% url 'turismo:lugar_list' %}">Lugares Turísticos</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ lugar.nombre }}</li>
            </ol>
        </nav>
    </div>
</section>
{% endblock %}

{% block content %}
<!-- Hero Image -->
<section class="detail-hero" style="background-image: url('{{ lugar.imagen_principal.url }}');">
    <div class="detail-hero-overlay"></div>
    <div class="container">
        <div class="detail-hero-content">
            <span class="detail-category">{{ lugar.categoria.nombre }}</span>
            <h1 class="detail-title">{{ lugar.nombre }}</h1>
            <div class="detail-meta">
                {% if lugar.direccion %}
                <div class="detail-meta-item">
                    <i class="ph-map-pin"></i> {{ lugar.direccion }}
                </div>
                {% endif %}
                {% if lugar.horario %}
                <div class="detail-meta-item">
                    <i class="ph-clock"></i> {{ lugar.horario }}
                </div>
                {% endif %}
                {% if lugar.costo_entrada %}
                <div class="detail-meta-item">
                    <i class="ph-ticket"></i> {{ lugar.costo_entrada }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<section class="section">
    <div class="container">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Description -->
                <div class="detail-section" data-aos="fade-up">
                    <h2 class="detail-section-title">Descripción</h2>
                    <div class="detail-content">
                        {{ lugar.descripcion|safe }}
                    </div>
                </div>

                <!-- Gallery -->
                {% if lugar.imagenes.all %}
                <div class="detail-section" data-aos="fade-up">
                    <h2 class="detail-section-title">Galería de imágenes</h2>
                    <div class="detail-gallery" id="lightgallery">
                        {% for imagen in lugar.imagenes.all %}
                        <a href="{{ imagen.imagen.url }}" class="gallery-item" data-lg-size="1600-1067" data-src="{{ imagen.imagen.url }}" data-sub-html="<h4>{{ imagen.titulo|default:lugar.nombre }}</h4>">
                            <img src="{{ imagen.imagen.url }}" alt="{{ imagen.titulo|default:lugar.nombre }}" class="img-fluid">
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Map -->
                {% if lugar.tiene_coordenadas %}
                <div class="detail-section" data-aos="fade-up">
                    <h2 class="detail-section-title">Ubicación</h2>
                    <div class="detail-map">
                        <div id="map" class="google-map" data-lat="{{ lugar.latitud }}" data-lng="{{ lugar.longitud }}" data-title="{{ lugar.nombre }}"></div>
                    </div>
                    <div class="mt-3">
                        <a href="https://www.google.com/maps/dir/?api=1&destination={{ lugar.latitud }},{{ lugar.longitud }}&travelmode=driving" class="btn btn-outline-primary" target="_blank">
                            <i class="ph-map-pin"></i> Cómo llegar
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Rutas relacionadas -->
                {% if lugar.get_rutas %}
                <div class="detail-section" data-aos="fade-up">
                    <h2 class="detail-section-title">Rutas turísticas que incluyen este lugar</h2>
                    <div class="row">
                        {% for ruta in lugar.get_rutas %}
                        <div class="col-md-6 mb-4">
                            <div class="route-card">
                                <div class="route-img">
                                    {% if ruta.imagen_principal %}
                                    <img src="{{ ruta.imagen_principal.url }}" alt="{{ ruta.nombre }}">
                                    {% else %}
                                    <img src="{% static 'img/placeholder.jpg' %}" alt="{{ ruta.nombre }}">
                                    {% endif %}
                                    <div class="route-difficulty route-difficulty-{{ ruta.dificultad }}">
                                        {{ ruta.get_dificultad_display }}
                                    </div>
                                </div>
                                <div class="route-content">
                                    <h3 class="route-title">
                                        <a href="{% url 'turismo:ruta_detail' ruta.slug %}">{{ ruta.nombre }}</a>
                                    </h3>
                                    <div class="route-meta">
                                        <div class="route-meta-item">
                                            <i class="ph-clock"></i> {{ ruta.duracion_estimada }}
                                        </div>
                                        <div class="route-meta-item">
                                            <i class="ph-ruler"></i> {{ ruta.distancia }} km
                                        </div>
                                    </div>
                                    <a href="{% url 'turismo:ruta_detail' ruta.slug %}" class="btn btn-sm btn-primary">Ver ruta</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Comentarios -->
                <div class="detail-section" data-aos="fade-up">
                    <h2 class="detail-section-title">Comentarios</h2>
                    
                    {% if lugar.comentarios.all %}
                    <div class="comments-list">
                        {% for comentario in lugar.comentarios.all %}
                        {% if comentario.aprobado %}
                        <div class="comment-item">
                            <div class="comment-header">
                                <div class="comment-author">{{ comentario.nombre }}</div>
                                <div class="comment-date">{{ comentario.created|date:"d M, Y" }}</div>
                            </div>
                            <div class="comment-content">
                                {{ comentario.contenido }}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="ph-info"></i> No hay comentarios aún. ¡Sé el primero en compartir tu experiencia!
                    </div>
                    {% endif %}

                    <!-- Formulario de comentarios -->
                    <div class="comment-form-container">
                        <h3 class="comment-form-title">Deja un comentario</h3>
                        <form method="post" action="#" class="comment-form">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="nombre" class="form-label">Nombre *</label>
                                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email *</label>
                                        <input type="email" class="form-control" id="email" name="email" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="contenido" class="form-label">Comentario *</label>
                                <textarea class="form-control" id="contenido" name="contenido" rows="5" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Publicar comentario</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="sidebar">
                    <!-- Share -->
                    <div class="sidebar-widget" data-aos="fade-up">
                        <h3 class="sidebar-title">Compartir</h3>
                        <div class="social-share">
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="social-share-btn facebook">
                                <i class="ph-facebook-logo"></i>
                            </a>
                            <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ lugar.nombre }}" target="_blank" class="social-share-btn twitter">
                                <i class="ph-twitter-logo"></i>
                            </a>
                            <a href="https://wa.me/?text={{ lugar.nombre }} {{ request.build_absolute_uri }}" target="_blank" class="social-share-btn whatsapp">
                                <i class="ph-whatsapp-logo"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Lugares relacionados -->
                    {% if lugares_relacionados %}
                    <div class="sidebar-widget" data-aos="fade-up">
                        <h3 class="sidebar-title">Lugares relacionados</h3>
                        <div class="related-places">
                            {% for lugar_rel in lugares_relacionados %}
                            <div class="related-place-item">
                                <div class="related-place-img">
                                    {% if lugar_rel.imagen_principal %}
                                    <img src="{{ lugar_rel.imagen_principal.url }}" alt="{{ lugar_rel.nombre }}">
                                    {% else %}
                                    <img src="{% static 'img/placeholder.jpg' %}" alt="{{ lugar_rel.nombre }}">
                                    {% endif %}
                                </div>
                                <div class="related-place-content">
                                    <h4 class="related-place-title">
                                        <a href="{% url 'turismo:lugar_detail' lugar_rel.slug %}">{{ lugar_rel.nombre }}</a>
                                    </h4>
                                    <div class="related-place-category">{{ lugar_rel.categoria.nombre }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Establecimientos cercanos -->
                    {% if establecimientos_cercanos %}
                    <div class="sidebar-widget" data-aos="fade-up">
                        <h3 class="sidebar-title">Dónde comer y alojarse</h3>
                        <div class="nearby-places">
                            {% for establecimiento in establecimientos_cercanos %}
                            <div class="nearby-place-item">
                                <div class="nearby-place-img">
                                    {% if establecimiento.imagen %}
                                    <img src="{{ establecimiento.imagen.url }}" alt="{{ establecimiento.nombre }}">
                                    {% else %}
                                    <img src="{% static 'img/placeholder.jpg' %}" alt="{{ establecimiento.nombre }}">
                                    {% endif %}
                                    <div class="nearby-place-type">{{ establecimiento.get_tipo_display }}</div>
                                </div>
                                <div class="nearby-place-content">
                                    <h4 class="nearby-place-title">
                                        <a href="{% url 'turismo:establecimiento_detail' establecimiento.slug %}">{{ establecimiento.nombre }}</a>
                                    </h4>
                                    <div class="nearby-place-address">
                                        <i class="ph-map-pin"></i> {{ establecimiento.direccion|truncatechars:30 }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="text-center mt-3">
                            <a href="{% url 'turismo:establecimiento_list' %}" class="btn btn-outline-primary">Ver todos</a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Light Gallery
        const galleryEl = document.getElementById('lightgallery');
        if (galleryEl) {
            lightGallery(galleryEl, {
                plugins: [lgZoom, lgThumbnail],
                speed: 500,
                selector: '.gallery-item'
            });
        }

        // Initialize Google Map
        const mapEl = document.getElementById('map');
        if (mapEl && typeof google !== 'undefined' && google.maps) {
            const lat = parseFloat(mapEl.dataset.lat);
            const lng = parseFloat(mapEl.dataset.lng);
            const title = mapEl.dataset.title;
            
            const map = new google.maps.Map(mapEl, {
                center: { lat, lng },
                zoom: 15,
                styles: [
                    {
                        "featureType": "administrative",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#444444"}]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "all",
                        "stylers": [{"color": "#f2f2f2"}]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "all",
                        "stylers": [{"saturation": -100}, {"lightness": 45}]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "all",
                        "stylers": [{"visibility": "simplified"}]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "labels.icon",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "all",
                        "stylers": [{"color": "#5DAD47"}, {"visibility": "on"}]
                    }
                ]
            });
            
            const marker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
                title: title,
                animation: google.maps.Animation.DROP,
                icon: {
                    url: '{% static "img/map-marker.png" %}',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
        }
    });
</script>
{% endblock %}