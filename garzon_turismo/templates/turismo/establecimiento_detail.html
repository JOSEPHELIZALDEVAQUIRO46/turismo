{% extends 'base.html' %}
{% load static %}

{% block title %}{{ establecimiento.nombre }} - {{ establecimiento.get_tipo_display }} - Alma del Huila{% endblock %}
{% block meta_description %}{{ establecimiento.descripcion|striptags|truncatewords:25 }}{% endblock %}

{% block body_class %}establecimiento-detail-page{% endblock %}

{% block breadcrumb %}
<section class="breadcrumb-section">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Inicio</a></li>
                <li class="breadcrumb-item"><a href="{% url 'turismo:establecimiento_list' %}">Establecimientos</a></li>
                <li class="breadcrumb-item"><a href="{% url 'turismo:establecimientos_tipo' establecimiento.tipo %}">{{ establecimiento.get_tipo_display }}s</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ establecimiento.nombre }}</li>
            </ol>
        </nav>
    </div>
</section>
{% endblock %}

{% block content %}
<!-- Hero Image -->
<section class="detail-hero" style="background-image: url('{{ establecimiento.imagen.url }}');">
    <div class="detail-hero-overlay"></div>
    <div class="container">
        <div class="detail-hero-content">
            <span class="detail-category">{{ establecimiento.get_tipo_display }}</span>
            <h1 class="detail-title">{{ establecimiento.nombre }}</h1>
            <div class="detail-rating">
                {% with rating=valoracion_media %}
                {% for i in "12345" %}
                    {% if forloop.counter <= rating %}
                    <i class="ph-star-fill"></i>
                    {% elif forloop.counter <= rating|add:0.5 %}
                    <i class="ph-star-half-fill"></i>
                    {% else %}
                    <i class="ph-star"></i>
                    {% endif %}
                {% endfor %}
                <span class="rating-text">{{ rating|floatformat:1 }} ({{ valoraciones|length }})</span>
                {% endwith %}
            </div>
            <div class="detail-meta">
                {% if establecimiento.direccion %}
                <div class="detail-meta-item">
                    <i class="ph-map-pin"></i> {{ establecimiento.direccion }}
                </div>
                {% endif %}
                {% if establecimiento.telefono %}
                <div class="detail-meta-item">
                    <i class="ph-phone"></i> {{ establecimiento.telefono }}
                </div>
                {% endif %}
                {% if establecimiento.horario %}
                <div class="detail-meta-item">
                    <i class="ph-clock"></i> {{ establecimiento.horario }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<section class="section">
    <div class="container">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Description -->
                <div class="detail-section" data-aos="fade-up">
                    <h2 class="detail-section-title">Descripción</h2>
                    <div class="detail-content">
                        {{ establecimiento.descripcion|safe }}
                    </div>
                    
                    <!-- Rango de precios -->
                    <div class="price-range">
                        <h3>Rango de precios:</h3>
                        <div class="price-indicator">
                            <span class="price-level {% if establecimiento.rango_precios == '$' %}active{% endif %}">$</span>
                            <span class="price-level {% if establecimiento.rango_precios == '$$' %}active{% endif %}">$$</span>
                            <span class="price-level {% if establecimiento.rango_precios == '$$$' %}active{% endif %}">$$$</span>
                        </div>
                        <div class="price-label">
                            {% if establecimiento.rango_precios == '$' %}
                            Económico
                            {% elif establecimiento.rango_precios == '$$' %}
                            Moderado
                            {% elif establecimiento.rango_precios == '$$$' %}
                            Costoso
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Servicios -->
                {% if establecimiento.get_servicios_list %}
                <div class="detail-section" data-aos="fade-up">
                    <h2 class="detail-section-title">Servicios</h2>
                    <div class="services-list">
                        {% for servicio in establecimiento.get_servicios_list %}
                        <div class="service-item">
                            <i class="ph-check-circle"></i>
                            <span>{{ servicio }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Map -->
                {% if establecimiento.tiene_coordenadas %}
                <div class="detail-section" data-aos="fade-up">
                    <h2 class="detail-section-title">Ubicación</h2>
                    <div class="detail-map">
                        <div id="map" class="google-map" data-lat="{{ establecimiento.latitud }}" data-lng="{{ establecimiento.longitud }}" data-title="{{ establecimiento.nombre }}"></div>
                    </div>
                    <div class="mt-3">
                        <a href="https://www.google.com/maps/dir/?api=1&destination={{ establecimiento.latitud }},{{ establecimiento.longitud }}&travelmode=driving" class="btn btn-outline-primary" target="_blank">
                            <i class="ph-map-pin"></i> Cómo llegar
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Contacto -->
                <div class="detail-section" data-aos="fade-up">
                    <h2 class="detail-section-title">Información de contacto</h2>
                    <div class="contact-info">
                        {% if establecimiento.telefono %}
                        <div class="contact-item">
                            <i class="ph-phone"></i>
                            <div class="contact-detail">
                                <h4>Teléfono</h4>
                                <p><a href="tel:{{ establecimiento.telefono }}">{{ establecimiento.telefono }}</a></p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if establecimiento.email %}
                        <div class="contact-item">
                            <i class="ph-envelope"></i>
                            <div class="contact-detail">
                                <h4>Email</h4>
                                <p><a href="mailto:{{ establecimiento.email }}">{{ establecimiento.email }}</a></p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if establecimiento.sitio_web %}
                        <div class="contact-item">
                            <i class="ph-globe"></i>
                            <div class="contact-detail">
                                <h4>Sitio web</h4>
                                <p><a href="{{ establecimiento.sitio_web }}" target="_blank">{{ establecimiento.sitio_web }}</a></p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Valoraciones -->
                <div class="detail-section" data-aos="fade-up">
                    <h2 class="detail-section-title">Valoraciones</h2>
                    
                    {% if valoraciones %}
                    <div class="ratings-summary">
                        <div class="ratings-average">
                            <div class="ratings-score">{{ valoracion_media|floatformat:1 }}</div>
                            <div class="ratings-stars">
                                {% with rating=valoracion_media %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= rating %}
                                    <i class="ph-star-fill"></i>
                                    {% elif forloop.counter <= rating|add:0.5 %}
                                    <i class="ph-star-half-fill"></i>
                                    {% else %}
                                    <i class="ph-star"></i>
                                    {% endif %}
                                {% endfor %}
                                {% endwith %}
                            </div>
                            <div class="ratings-count">{{ valoraciones|length }} valoraciones</div>
                        </div>
                    </div>
                    
                    <div class="ratings-list">
                        {% for valoracion in valoraciones %}
                        <div class="rating-item">
                            <div class="rating-header">
                                <div class="rating-author">{{ valoracion.nombre }}</div>
                                <div class="rating-date">{{ valoracion.created|date:"d M, Y" }}</div>
                            </div>
                            <div class="rating-stars">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= valoracion.puntuacion %}
                                    <i class="ph-star-fill"></i>
                                    {% else %}
                                    <i class="ph-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="rating-content">
                                {{ valoracion.comentario }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="ph-info"></i> No hay valoraciones aún. ¡Sé el primero en valorar este establecimiento!
                    </div>
                    {% endif %}

                    <!-- Formulario de valoración -->
                    <div class="rating-form-container">
                        <h3 class="rating-form-title">Deja tu valoración</h3>
                        <form method="post" action="{% url 'turismo:establecimiento_valorar' establecimiento.slug %}" class="rating-form">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="nombre" class="form-label">Nombre *</label>
                                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email *</label>
                                        <input type="email" class="form-control" id="email" name="email" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Puntuación *</label>
                                <div class="rating-input">
                                    <div class="rating-stars-input">
                                        <input type="radio" name="puntuacion" value="5" id="rating5" required>
                                        <label for="rating5"><i class="ph-star"></i></label>
                                        
                                        <input type="radio" name="puntuacion" value="4" id="rating4">
                                        <label for="rating4"><i class="ph-star"></i></label>
                                        
                                        <input type="radio" name="puntuacion" value="3" id="rating3">
                                        <label for="rating3"><i class="ph-star"></i></label>
                                        
                                        <input type="radio" name="puntuacion" value="2" id="rating2">
                                        <label for="rating2"><i class="ph-star"></i></label>
                                        
                                        <input type="radio" name="puntuacion" value="1" id="rating1">
                                        <label for="rating1"><i class="ph-star"></i></label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="comentario" class="form-label">Comentario</label>
                                <textarea class="form-control" id="comentario" name="comentario" rows="5"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Enviar valoración</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="sidebar">
                    <!-- Share -->
                    <div class="sidebar-widget" data-aos="fade-up">
                        <h3 class="sidebar-title">Compartir</h3>
                        <div class="social-share">
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="social-share-btn facebook">
                                <i class="ph-facebook-logo"></i>
                            </a>
                            <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ establecimiento.nombre }}" target="_blank" class="social-share-btn twitter">
                                <i class="ph-twitter-logo"></i>
                            </a>
                            <a href="https://wa.me/?text={{ establecimiento.nombre }} {{ request.build_absolute_uri }}" target="_blank" class="social-share-btn whatsapp">
                                <i class="ph-whatsapp-logo"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Horarios -->
                    {% if establecimiento.horario %}
                    <div class="sidebar-widget" data-aos="fade-up">
                        <h3 class="sidebar-title">Horarios</h3>
                        <div class="schedule-info">
                            {{ establecimiento.horario|linebreaks }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Lugares cercanos -->
                    {% if lugares_cercanos %}
                    <div class="sidebar-widget" data-aos="fade-up">
                        <h3 class="sidebar-title">Lugares turísticos cercanos</h3>
                        <div class="nearby-places">
                            {% for lugar in lugares_cercanos %}
                            <div class="nearby-place-item">
                                <div class="nearby-place-img">
                                    {% if lugar.imagen_principal %}
                                    <img src="{{ lugar.imagen_principal.url }}" alt="{{ lugar.nombre }}">
                                    {% else %}
                                    <img src="{% static 'img/placeholder.jpg' %}" alt="{{ lugar.nombre }}">
                                    {% endif %}
                                </div>
                                <div class="nearby-place-content">
                                    <h4 class="nearby-place-title">
                                        <a href="{% url 'turismo:lugar_detail' lugar.slug %}">{{ lugar.nombre }}</a>
                                    </h4>
                                    <div class="nearby-place-category">{{ lugar.categoria.nombre }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="text-center mt-3">
                            <a href="{% url 'turismo:lugar_list' %}" class="btn btn-outline-primary">Ver todos los lugares</a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Establecimientos similares -->
                    {% if establecimientos_similares %}
                    <div class="sidebar-widget" data-aos="fade-up">
                        <h3 class="sidebar-title">{{ establecimiento.get_tipo_display }}s similares</h3>
                        <div class="similar-places">
                            {% for similar in establecimientos_similares %}
                            <div class="similar-place-item">
                                <div class="similar-place-img">
                                    {% if similar.imagen %}
                                    <img src="{{ similar.imagen.url }}" alt="{{ similar.nombre }}">
                                    {% else %}
                                    <img src="{% static 'img/placeholder.jpg' %}" alt="{{ similar.nombre }}">
                                    {% endif %}
                                </div>
                                <div class="similar-place-content">
                                    <h4 class="similar-place-title">
                                        <a href="{% url 'turismo:establecimiento_detail' similar.slug %}">{{ similar.nombre }}</a>
                                    </h4>
                                    <div class="similar-place-rating">
                                        {% with rating=similar.get_valoracion_promedio %}
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= rating %}
                                            <i class="ph-star-fill"></i>
                                            {% elif forloop.counter <= rating|add:0.5 %}
                                            <i class="ph-star-half-fill"></i>
                                            {% else %}
                                            <i class="ph-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Rating stars input
        const ratingInputs = document.querySelectorAll('.rating-stars-input input');
        const ratingLabels = document.querySelectorAll('.rating-stars-input label');
        
        ratingInputs.forEach((input, index) => {
            input.addEventListener('change', function() {
                // Reset all stars
                ratingLabels.forEach((label, i) => {
                    if (i <= index) {
                        label.querySelector('i').classList.remove('ph-star');
                        label.querySelector('i').classList.add('ph-star-fill');
                    } else {
                        label.querySelector('i').classList.remove('ph-star-fill');
                        label.querySelector('i').classList.add('ph-star');
                    }
                });
            });
        });
        
        // Initialize Google Map
        const mapEl = document.getElementById('map');
        if (mapEl && typeof google !== 'undefined' && google.maps) {
            const lat = parseFloat(mapEl.dataset.lat);
            const lng = parseFloat(mapEl.dataset.lng);
            const title = mapEl.dataset.title;
            
            const map = new google.maps.Map(mapEl, {
                center: { lat, lng },
                zoom: 15,
                styles: [
                    {
                        "featureType": "administrative",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#444444"}]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "all",
                        "stylers": [{"color": "#f2f2f2"}]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "all",
                        "stylers": [{"saturation": -100}, {"lightness": 45}]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "all",
                        "stylers": [{"visibility": "simplified"}]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "labels.icon",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "all",
                        "stylers": [{"color": "#5DAD47"}, {"visibility": "on"}]
                    }
                ]
            });
            
            const marker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
                title: title,
                animation: google.maps.Animation.DROP,
                icon: {
                    url: '{% static "img/map-marker.png" %}',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
        }
    });
</script>
{% endblock %}