{% extends 'base.html' %}
{% load static %}

{% block title %}Mapa Interactivo - {{ block.super }}{% endblock %}

{% block meta_description %}
Explora Garzón, Huila en nuestro mapa interactivo. Descubre lugares turísticos, establecimientos, actividades y más.
{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb-section">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Inicio</a></li>
                <li class="breadcrumb-item"><a href="{% url 'turismo:lugar_list' %}">Turismo</a></li>
                <li class="breadcrumb-item active" aria-current="page">Mapa Interactivo</li>
            </ol>
        </nav>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Section Header Con Colores Corregidos -->
<section style="background-color: var(--color-primary); color: white; padding: 1.5rem 0;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-2 fw-bold" style="color: var(--color-secondary); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;">Explora Garzón</h2>
                <h1 class="h3 mb-2 fw-bold" style="color: white;">MAPA INTERACTIVO</h1>
                <p class="mb-0" style="color: white;">Descubre atractivos turísticos, establecimientos y actividades</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="fw-bold" style="color: var(--color-secondary); font-size: 1.5rem;" data-target="{{ total_marcadores }}">0</div>
                        <small style="color: white;">Ubicaciones</small>
                    </div>
                    <div class="col-6">
                        <div class="fw-bold" style="color: var(--color-secondary); font-size: 1.5rem;" data-target="{{ estadisticas_tipos.lugar|default:0 }}">0</div>
                        <small style="color: white;">Lugares</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Map Controls -->
<section class="bg-light py-3">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex flex-wrap align-items-center">
                    <h6 class="text-primary fw-bold me-4 mb-0">FILTROS DEL MAPA:</h6>
                    
                    <div class="form-check form-switch me-4 mb-2">
                        <input class="form-check-input" type="checkbox" id="filtroLugares" checked>
                        <label class="form-check-label fw-medium" for="filtroLugares">
                            <i class="ph-mountains text-primary me-1"></i>
                            Lugares Turísticos
                        </label>
                    </div>

                    <div class="form-check form-switch me-4 mb-2">
                        <input class="form-check-input" type="checkbox" id="filtroEstablecimientos" checked>
                        <label class="form-check-label fw-medium" for="filtroEstablecimientos">
                            <i class="ph-buildings text-primary me-1"></i>
                            Establecimientos
                        </label>
                    </div>

                    <div class="form-check form-switch me-4 mb-2">
                        <input class="form-check-input" type="checkbox" id="filtroActividades" checked>
                        <label class="form-check-label fw-medium" for="filtroActividades">
                            <i class="ph-bicycle text-primary me-1"></i>
                            Actividades
                        </label>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-lg-end">
                <button class="btn btn-outline-primary btn-sm" id="centrarMapa">
                    <i class="ph-crosshairs me-1"></i>
                    Centrar en Garzón
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Layout en Dos Columnas -->
<section class="py-4">
    <div class="container">
        <div class="row g-4">
            <!-- Columna Izquierda: Mapa -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-0 position-relative">
                        <div id="mapContainer" style="height: 500px; width: 100%; border-radius: var(--border-radius);"></div>
                        
                        <!-- Loading del Mapa -->
                        <div id="mapLoading" class="position-absolute top-50 start-50 translate-middle text-center">
                            <div class="spinner-border" style="color: var(--color-primary);" role="status">
                                <span class="visually-hidden">Cargando mapa...</span>
                            </div>
                            <p class="mt-2 fw-medium fs-sm" style="color: var(--color-text);">CARGANDO MAPA...</p>
                        </div>

                        <!-- Panel de Información -->
                        <div id="infoPanel" class="position-absolute top-0 end-0 bg-white p-3 m-2 shadow" 
                             style="width: 280px; max-height: 350px; overflow-y: auto; display: none; border-radius: var(--border-radius);">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0 fw-bold fs-sm" style="color: var(--color-primary);" id="infoPanelTitle">INFORMACIÓN</h6>
                                <button class="btn-close btn-sm" id="cerrarInfoPanel"></button>
                            </div>
                            <div id="infoPanelContent">
                                <!-- Contenido dinámico -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Categorías y Estadísticas -->
            <div class="col-lg-4">
                <div class="d-flex flex-column h-100">
                    <!-- Categorías en Cuadrícula -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <h5 class="fw-bold mb-3" style="color: var(--color-primary);">EXPLORAR CATEGORÍAS</h5>
                            <div class="row g-2">
                                <div class="col-6">
                                    <a href="{% url 'turismo:lugar_list' %}" class="d-block w-100 py-3 text-center text-decoration-none" 
                                       style="border: 2px solid var(--color-primary); color: var(--color-primary); border-radius: var(--border-radius); background: white; transition: var(--transition); min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center;"
                                       onmouseover="this.style.backgroundColor='var(--color-primary)'; this.style.color='white';"
                                       onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-primary)';">
                                        <i class="ph-mountains mb-1" style="font-size: 1.5rem;"></i>
                                        <small class="fw-bold">LUGARES</small>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="{% url 'turismo:establecimiento_list' %}" class="d-block w-100 py-3 text-center text-decoration-none"
                                       style="border: 2px solid var(--color-primary); color: var(--color-primary); border-radius: var(--border-radius); background: white; transition: var(--transition); min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center;"
                                       onmouseover="this.style.backgroundColor='var(--color-primary)'; this.style.color='white';"
                                       onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-primary)';">
                                        <i class="ph-buildings mb-1" style="font-size: 1.5rem;"></i>
                                        <small class="fw-bold">HOTELES</small>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="{% url 'turismo:actividades_fisicas_list' %}" class="d-block w-100 py-3 text-center text-decoration-none"
                                       style="border: 2px solid var(--color-primary); color: var(--color-primary); border-radius: var(--border-radius); background: white; transition: var(--transition); min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center;"
                                       onmouseover="this.style.backgroundColor='var(--color-primary)'; this.style.color='white';"
                                       onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-primary)';">
                                        <i class="ph-bicycle mb-1" style="font-size: 1.5rem;"></i>
                                        <small class="fw-bold">ACTIVIDADES</small>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="{% url 'turismo:ruta_list' %}" class="d-block w-100 py-3 text-center text-decoration-none"
                                       style="border: 2px solid var(--color-primary); color: var(--color-primary); border-radius: var(--border-radius); background: white; transition: var(--transition); min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center;"
                                       onmouseover="this.style.backgroundColor='var(--color-primary)'; this.style.color='white';"
                                       onmouseout="this.style.backgroundColor='white'; this.style.color='var(--color-primary)';">
                                        <i class="ph-map-trifold mb-1" style="font-size: 1.5rem;"></i>
                                        <small class="fw-bold">RUTAS</small>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estadísticas -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <h5 class="fw-bold mb-3" style="color: var(--color-primary);">ESTADÍSTICAS</h5>
                            <div class="row text-center g-2">
                                <div class="col-4">
                                    <div class="p-2 text-center" style="background: var(--color-light); border-radius: var(--border-radius);">
                                        <div class="h5 mb-1 fw-bold" style="color: var(--color-primary);" id="contadorLugares">0</div>
                                        <small style="color: var(--color-text); font-size: 0.75rem;">Lugares</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2 text-center" style="background: var(--color-light); border-radius: var(--border-radius);">
                                        <div class="h5 mb-1 fw-bold" style="color: var(--color-primary);" id="contadorEstablecimientos">0</div>
                                        <small style="color: var(--color-text); font-size: 0.75rem;">Hoteles</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2 text-center" style="background: var(--color-light); border-radius: var(--border-radius);">
                                        <div class="h5 mb-1 fw-bold" style="color: var(--color-primary);" id="contadorActividades">0</div>
                                        <small style="color: var(--color-text); font-size: 0.75rem;">Actividades</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botón Centrar Mapa -->
                    <div class="card border-0 shadow-sm mt-auto">
                        <div class="card-body">
                            <button class="w-100 py-3 fw-bold border-0" id="centrarMapa"
                                    style="color: var(--color-primary); border-radius: var(--border-radius); background: var(--color-light); transition: var(--transition);"
                                    onmouseover="this.style.backgroundColor='var(--color-primary)'; this.style.color='white';"
                                    onmouseout="this.style.backgroundColor='var(--color-light)'; this.style.color='var(--color-primary)';">
                                <i class="ph-crosshairs me-2"></i>
                                CENTRAR EN GARZÓN
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Google Maps API -->
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVxz-5XL-Irl8AII_GwTo6nqe7eCDoyeo&callback=initMapaGarzon&libraries=geometry">
</script>

<script>
let mapaGarzon;
let marcadores = [];
let infoWindow;
const dataMarcadores = {{ marcadores_json|safe }};

// Configuración del mapa siguiendo el manual de marca
const configMapa = {
    center: { lat: 2.1964, lng: -75.6472 }, // Garzón, Huila
    zoom: 13,
    styles: [
        {
            "featureType": "administrative",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#333333"}]
        },
        {
            "featureType": "landscape",
            "elementType": "all",
            "stylers": [{"color": "#f9f9f9"}]
        },
        {
            "featureType": "poi",
            "elementType": "labels",
            "stylers": [{"visibility": "off"}]
        },
        {
            "featureType": "road",
            "elementType": "all",
            "stylers": [
                {"saturation": -100},
                {"lightness": 45}
            ]
        },
        {
            "featureType": "road.highway",
            "elementType": "all",
            "stylers": [{"visibility": "simplified"}]
        },
        {
            "featureType": "road.arterial",
            "elementType": "labels.icon",
            "stylers": [{"visibility": "off"}]
        },
        {
            "featureType": "transit",
            "elementType": "all",
            "stylers": [{"visibility": "off"}]
        },
        {
            "featureType": "water",
            "elementType": "all",
            "stylers": [
                {"color": "#5DAD47"}, // Verde Garzón
                {"visibility": "on"}
            ]
        }
    ]
};

// Iconos usando los colores del manual de marca
const iconosMarcadores = {
    lugar: {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 24 29">
                <path d="M12 0C5.373 0 0 5.373 0 12c0 9 12 17 12 17s12-8 12-17c0-6.627-5.373-12-12-12zm0 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z" fill="#5DAD47"/>
                <circle cx="12" cy="12" r="3" fill="#ffffff"/>
            </svg>
        `),
        scaledSize: new google.maps.Size(32, 40),
        anchor: new google.maps.Point(16, 40)
    },
    establecimiento: {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 24 29">
                <path d="M12 0C5.373 0 0 5.373 0 12c0 9 12 17 12 17s12-8 12-17c0-6.627-5.373-12-12-12zm0 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z" fill="#F4DC26"/>
                <circle cx="12" cy="12" r="3" fill="#333333"/>
            </svg>
        `),
        scaledSize: new google.maps.Size(32, 40),
        anchor: new google.maps.Point(16, 40)
    },
    actividad: {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 24 29">
                <path d="M12 0C5.373 0 0 5.373 0 12c0 9 12 17 12 17s12-8 12-17c0-6.627-5.373-12-12-12zm0 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z" fill="#4CAF50"/>
                <circle cx="12" cy="12" r="3" fill="#ffffff"/>
            </svg>
        `),
        scaledSize: new google.maps.Size(32, 40),
        anchor: new google.maps.Point(16, 40)
    }
};

function initMapaGarzon() {
    // Ocultar loading
    document.getElementById('mapLoading').style.display = 'none';
    
    // Crear mapa
    mapaGarzon = new google.maps.Map(document.getElementById('mapContainer'), configMapa);
    
    // Crear info window
    infoWindow = new google.maps.InfoWindow({
        maxWidth: 300
    });
    
    // Agregar marcadores
    agregarMarcadoresGarzon();
    
    // Configurar controles
    configurarControlesMapa();
    
    // Actualizar contadores
    actualizarContadoresMapa();
}

function agregarMarcadoresGarzon() {
    dataMarcadores.forEach(function(marcadorData) {
        const marcador = new google.maps.Marker({
            position: { lat: marcadorData.latitud, lng: marcadorData.longitud },
            map: mapaGarzon,
            title: marcadorData.nombre,
            icon: iconosMarcadores[marcadorData.tipo] || iconosMarcadores.lugar,
            tipo: marcadorData.tipo,
            animation: google.maps.Animation.DROP
        });
        
        // Contenido del info window siguiendo el estilo de marca
        const contenidoInfo = `
            <div style="font-family: 'Oswald', sans-serif; max-width: 280px;">
                <h6 style="color: #5DAD47; font-weight: 700; text-transform: uppercase; margin-bottom: 8px;">
                    ${marcadorData.nombre}
                </h6>
                ${marcadorData.imagen ? `
                    <img src="${marcadorData.imagen}" 
                         alt="${marcadorData.nombre}" 
                         style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
                ` : ''}
                <p style="color: #666; font-family: 'Roboto', sans-serif; font-size: 13px; margin-bottom: 8px;">
                    <strong style="color: #5DAD47;">${marcadorData.categoria}</strong>
                </p>
                ${marcadorData.descripcion ? `
                    <p style="color: #666; font-family: 'Roboto', sans-serif; font-size: 12px; margin-bottom: 12px;">
                        ${marcadorData.descripcion}
                    </p>
                ` : ''}
                ${marcadorData.url ? `
                    <a href="${marcadorData.url}" 
                       style="display: inline-block; background-color: #5DAD47; color: white; 
                              padding: 6px 12px; text-decoration: none; border-radius: 4px; 
                              font-weight: 600; font-size: 12px; text-transform: uppercase;">
                        VER DETALLES
                    </a>
                ` : ''}
            </div>
        `;
        
        marcador.addListener('click', function() {
            infoWindow.setContent(contenidoInfo);
            infoWindow.open(mapaGarzon, marcador);
            
            // Mostrar panel de información en pantallas grandes
            if (window.innerWidth > 768) {
                mostrarPanelInfo(marcadorData);
            }
        });
        
        marcadores.push(marcador);
    });
}

function mostrarPanelInfo(marcadorData) {
    const panel = document.getElementById('infoPanel');
    const titulo = document.getElementById('infoPanelTitle');
    const contenido = document.getElementById('infoPanelContent');
    
    titulo.textContent = marcadorData.nombre.toUpperCase();
    
    let contenidoPanel = `
        <div class="mb-3">
            ${marcadorData.imagen ? `
                <img src="${marcadorData.imagen}" 
                     alt="${marcadorData.nombre}" 
                     class="img-fluid rounded mb-3" 
                     style="max-height: 150px; width: 100%; object-fit: cover;">
            ` : ''}
            <div class="mb-2">
                <span class="badge bg-primary fw-bold">${marcadorData.categoria}</span>
            </div>
            ${marcadorData.descripcion ? `
                <p class="text-muted" style="font-size: 14px;">${marcadorData.descripcion}</p>
            ` : ''}
        </div>
    `;
    
    // Información específica por tipo
    if (marcadorData.tipo === 'actividad' && marcadorData.dificultad) {
        contenidoPanel += `
            <div class="mb-3">
                <strong class="text-primary">DIFICULTAD:</strong> ${marcadorData.dificultad}
            </div>
        `;
    }
    
    if (marcadorData.url) {
        contenidoPanel += `
            <a href="${marcadorData.url}" class="btn btn-primary w-100 fw-bold">
                VER DETALLES COMPLETOS
            </a>
        `;
    }
    
    contenido.innerHTML = contenidoPanel;
    panel.style.display = 'block';
}

function configurarControlesMapa() {
    // Filtros de marcadores
    document.getElementById('filtroLugares').addEventListener('change', function() {
        filtrarMarcadoresPorTipo('lugar', this.checked);
    });
    
    document.getElementById('filtroEstablecimientos').addEventListener('change', function() {
        filtrarMarcadoresPorTipo('establecimiento', this.checked);
    });
    
    document.getElementById('filtroActividades').addEventListener('change', function() {
        filtrarMarcadoresPorTipo('actividad', this.checked);
    });
    
    // Centrar mapa
    document.getElementById('centrarMapa').addEventListener('click', function() {
        mapaGarzon.setCenter(configMapa.center);
        mapaGarzon.setZoom(configMapa.zoom);
        infoWindow.close();
    });
    
    // Cerrar panel de información
    document.getElementById('cerrarInfoPanel').addEventListener('click', function() {
        document.getElementById('infoPanel').style.display = 'none';
    });
    
    // Cerrar panel al hacer clic en el mapa
    mapaGarzon.addListener('click', function() {
        document.getElementById('infoPanel').style.display = 'none';
    });
}

function filtrarMarcadoresPorTipo(tipo, mostrar) {
    marcadores.forEach(function(marcador) {
        if (marcador.tipo === tipo) {
            marcador.setVisible(mostrar);
        }
    });
    actualizarContadoresMapa();
}

function actualizarContadoresMapa() {
    let contadores = { lugar: 0, establecimiento: 0, actividad: 0 };
    
    marcadores.forEach(function(marcador) {
        if (marcador.getVisible()) {
            contadores[marcador.tipo] = (contadores[marcador.tipo] || 0) + 1;
        }
    });
    
    document.getElementById('contadorLugares').textContent = contadores.lugar || 0;
    document.getElementById('contadorEstablecimientos').textContent = contadores.establecimiento || 0;
    document.getElementById('contadorActividades').textContent = contadores.actividad || 0;
}

// Hacer el mapa responsivo
window.addEventListener('resize', function() {
    if (mapaGarzon) {
        google.maps.event.trigger(mapaGarzon, 'resize');
        mapaGarzon.setCenter(configMapa.center);
    }
});

// Manejar errores de carga de Google Maps
window.gm_authFailure = function() {
    document.getElementById('mapLoading').innerHTML = `
        <div class="alert alert-danger text-center">
            <h6 class="text-primary fw-bold">ERROR AL CARGAR EL MAPA</h6>
            <p class="mb-0">No se pudo cargar Google Maps. Verifica la configuración de la API key.</p>
        </div>
    `;
};
</script>
{% endblock %}